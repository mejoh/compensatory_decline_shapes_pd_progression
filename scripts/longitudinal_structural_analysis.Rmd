---
title: 'Microstructural changes underlying the clinical progression of Parkinson''s disease'
author: "M.E. Johansson"
date: "01/27/2025"
output: 
  html_document: 
    toc: yes
    toc_float: true
    number_sections: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Project description

<>

# Main

## Data preparation

Loading the following data:

```{r LIBS, echo=F,warning=F,message=F}
# Set paths and parameters
options(contrasts=c("contr.sum", "contr.poly"))
sigsize=5
lsize=0.6
legend_position <- c(0.8,1.1)

# Load libraries
library(ppcor)
library(tidyverse)
library(tidymodels)
library(multilevelmod)
library(readxl)
library(sjPlot)
library(cowplot)
library(lme4)
library(lmerTest)
library(broom.mixed)
library(vtable)
library(rmcorr)
library(msm)
library(emmeans)
library(ggeffects)
library(GGally)
library(MatchIt)
library(rstatix)
library(car)
library(effectsize)
library(ggpubr)
library(MatchIt)
library(extrafont)
loadfonts(device='win',quiet = TRUE)
```

 - Free water (FW) estimates from the posterior substantia nigra (SN)

```{r LOAD-FW, echo=F,warning=F,message=F}
# Load DTI data
read_dti_metrics <- function(filename){
    df <- read_delim(filename, delim = ',', trim_ws = T)
    df <- df %>%
        mutate(pseudonym = str_extract(IMG,"(?<=qsiprep/).+(?=/ses)"),
               Timepoint = str_extract(IMG,"(?<=ses-).+(?=/metrics)"),
               TimepointNr = if_else(str_detect(Timepoint,'Visit1'),0,2),
               ParticipantType = if_else(str_detect(Timepoint,'POM'),
                                         'Patient','Healthy'),
               TimepointNr = TimepointNr) %>%
        select(-c(IMG,Timepoint)) %>%
        relocate(pseudonym,ParticipantType,TimepointNr) %>%
        arrange(ParticipantType,pseudonym,TimepointNr)
    
    df
}
df_dti <- read_dti_metrics('P:/3024006.02/Analyses/MJF_FreeWater/data/n2_pasternak_fw/FW_stats_avg.csv') %>%
  left_join(., read_dti_metrics('P:/3024006.02/Analyses/MJF_FreeWater/data/n2_pasternak_fw/FW_stats_sd.csv'), by = c('pseudonym','ParticipantType','TimepointNr'))
```

 - Compensatory brain activity, to correlate with cMD

```{r LOAD-COMP, echo=F,warning=F,message=F}
# Load fMRI data (longitudinal changes in compensation that correlate with bradykinesia progression)
read_fmri <- function(fname){
  dat <- read_csv(fname, col_names = F) %>%
    mutate(X1=basename(X1),
           pseudonym = str_sub(X1, 8,31),
           ParticipantType = str_sub(X1, 1,6),
           ParticipantType = if_else(ParticipantType=='PD_POM','Patient','Healthy')) %>%
    relocate(pseudonym,ParticipantType) %>%
    select(-c(X1))
  dat
}
df_compensation_AddCov2 <- read_fmri('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0007/vals/rand_delta_clincorr_all_vxlEV_AddCov2_tfce_corrp_tstat2_stats_stats_avg_agg.txt') %>%
  rename(T2sub0_R_FEF=X2) %>%
  mutate(TimepointNr=0,contrast='con_0007', .after = ParticipantType) %>%
  left_join(., read_fmri('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0007/vals/rand_delta_clincorr_all_vxlEV_AddCov2_tfce_corrp_tstat2_stats_BASELINE_stats_avg_agg.txt')) %>%
  rename(T0_R_FEF=X2)

df_compensation_AddCov0 <- read_fmri('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0007/vals/rand_delta_clincorr_all_vxlEV_tfce_corrp_tstat2_stats_stats_avg_agg.txt') %>%
  rename(T2sub0_R_FEF=X2,T2sub0_L_FEF=X3) %>%
  mutate(TimepointNr=0,contrast='con_0007', .after = ParticipantType) %>%
  left_join(., read_fmri('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/stats/con_0007/vals/rand_delta_clincorr_all_vxlEV_tfce_corrp_tstat2_stats_BASELINE_stats_avg_agg.txt')) %>%
  rename(T0_R_FEF=X2,T0_L_FEF=X3) %>%
  mutate(T2sub0_bi_FEF_comp = (T2sub0_R_FEF+T2sub0_L_FEF) / 2,
         T0_bi_FEF_comp = (T0_R_FEF+T0_L_FEF) / 2)
```

 - Surface-projected estimates of cortical mean diffusivity (cMD)

```{r LOAD-SURF, echo=F,warning=F,message=F}
# Load FreeSurfer data
read_fs_metrics <- function(filename){
  df <- read_csv(filename) %>%
    rename(pseudonym=SubjID) %>%
    mutate(TimepointNr = str_sub(pseudonym, start=26,end=27),
           TimepointNr = if_else(TimepointNr=='t1',0,2),
           pseudonym = str_sub(pseudonym, start=1, end=24)) %>%
    relocate(pseudonym, TimepointNr)
  
  df
}
fs_exclusions <- c('sub-POMU56F70F8137CF0C55', 'sub-POMU6059DC1B31E11124')
volume_rois <- c('thal','caud','put','pal','accumb','amyg')
# surface_rois <- c('inferiorparietal','superiorparietal','precuneus','supramarginal',
          # 'paracentral','postcentral','precentral',
          # 'superiorfrontal','caudalmiddlefrontal','rostralanteriorcingulate')
surface_rois <- c( "caudalanteriorcingulate","caudalmiddlefrontal",
                   "cuneus","entorhinal","fusiform","inferiorparietal",
                   "inferiortemporal","isthmuscingulate","lateraloccipital",
                   "lateralorbitofrontal","lingual","medialorbitofrontal",
                   "middletemporal","parahippocampal","paracentral",
                   "parsopercularis","parsorbitalis","parstriangularis",
                   "pericalcarine","postcentral","posteriorcingulate",
                   "precentral","precuneus","rostralanteriorcingulate",
                   "rostralmiddlefrontal","superiorfrontal","superiorparietal",
                   "superiortemporal","supramarginal","frontalpole",
                   "temporalpole","transversetemporal","insula")
df_fs_vol <- read_fs_metrics('P:/3022026.01/pep/bids/derivatives/freesurfer_v7.3.2/outputs/metrics/measures/LandRvolumes.csv') %>%
  select(pseudonym,TimepointNr,TSCGMV,TCGMV,TGMV,ICV,contains(volume_rois))
df_fs_surf <- read_fs_metrics('P:/3022026.01/pep/bids/derivatives/freesurfer_v7.3.2/outputs/metrics/measures/CorticalMeasuresENIGMA_SurfAvg.csv') %>%
  select(pseudonym,TimepointNr,contains(surface_rois))
df_fs_thick <- read_fs_metrics('P:/3022026.01/pep/bids/derivatives/freesurfer_v7.3.2/outputs/metrics/measures/CorticalMeasuresENIGMA_ThickAvg.csv') %>%
  select(pseudonym,TimepointNr,contains(surface_rois))
# Add MD to FreeSurfer metrics
metric <- c('fsl_MD','TensorFWCorrected_dcmp_MD')
metric <- metric[1]
df_fs_md <- read_csv(paste0('P:/3022026.01/pep/bids/derivatives/qsiprep/measures/1_NoPVC_projfrac02-08-01_correctb0orientation/SurfaceMeasures_',metric,'_T1w_Mean.csv')) %>%
  rename(pseudonym = SubjID) %>%
  mutate(TimepointNr = if_else(str_detect(Timepoint,'Visit1'),0,2)) %>%
  relocate(pseudonym, TimepointNr) %>%
  select(-Timepoint) %>% select(pseudonym,TimepointNr,contains(surface_rois)) %>%
  na.omit()
df_fs <- df_fs_vol %>% 
  left_join(df_fs_surf, by = c('pseudonym','TimepointNr')) %>%
  left_join(df_fs_thick, by = c('pseudonym','TimepointNr')) %>% 
  left_join(df_fs_md, by = c('pseudonym', 'TimepointNr')) %>%
  filter(! pseudonym %in% fs_exclusions)
# Create bilateral versions of each FreeSurfer metric
for(roi in volume_rois){
  bi_roi <- tibble(
    roi=(
      (df_fs %>% pull(paste0('L',roi)) + df_fs %>% pull(paste0('R',roi))) / 2
    )
  )
  colnames(bi_roi) <- paste0('bi_',roi)
  df_fs <- df_fs %>% bind_cols(bi_roi)
}
for(roi in surface_rois){
  for(m in c('surfavg','thickavg','dti')){
    bi_roi <- tibble(
      roi=(
        (df_fs %>% pull(paste('L',roi,m,sep='_')) + df_fs %>% pull(paste('R',roi,m,sep='_'))) / 2
      )
    )
    colnames(bi_roi) <- paste('bi',roi,m,sep='_')
    df_fs <- df_fs %>% bind_cols(bi_roi)
  }
}
if(metric == 'TensorFWCorrected_dcmp_MD'){
        # df.plot %>% 
        #         filter(ParticipantType=='Patient',
        #                ROI=='bi_superiorfrontal_dti') %>%
        #         arrange(Value) %>%
        #         slice(1:2) %>%
        #         pull(pseudonym)
        df_fs <- df_fs %>%
                filter(!(pseudonym %in% c("sub-POMU32C52AEA06F071F1","sub-POMU32A3C60CF70B22F5")))
}
```

 - Clinical data

```{r LOAD-CLIN, echo=F,warning=F,message=F}
# Load clinical data
read_clinical_metrics <- function(filename, clinical_metrics){
  df <- read_csv(filename,
                 col_select = all_of(clinical_metrics)) %>%
    filter(ParticipantType != 'PD_PIT') %>%
    mutate(ParticipantType = if_else(ParticipantType == 'PD_POM','Patient','Healthy'),
           TimepointNr = if_else(ParticipantType == 'Healthy' & TimepointNr == 1, 2, TimepointNr)) %>%
    filter(TimepointNr != 1)
  subtypes <- df %>%
    filter(TimepointNr == 0) %>%
    select(pseudonym)
  
  # Identify patients whose PD diagnosis has been re-evaluated
  diagnosis <- df %>% select(pseudonym, TimepointNr, DiagParkCertain, DiagParkPersist, DiagParkReplace)
  baseline_exclusion <- diagnosis %>%
          filter(TimepointNr==0, (DiagParkCertain == 'NeitherDisease' | DiagParkCertain == 'DoubtAboutParkinsonism' | DiagParkCertain == 'Parkinsonism')) %>% 
          select(pseudonym, DiagParkCertain)
  visit2_exclusion <- diagnosis %>%
          filter(TimepointNr==2, (DiagParkPersist == 2)) %>% 
          select(pseudonym, DiagParkPersist, DiagParkReplace)
  diag_exclusions <- full_join(baseline_exclusion, visit2_exclusion, by='pseudonym') %>% 
          unique()
  df <- df %>%
    mutate(Misdiagnosis = if_else(pseudonym %in% diag_exclusions$pseudonym,1,0))
  
  df     
}
clinical_metrics <- c('pseudonym','ParticipantType','TimepointNr','YearsToFollowUp','MriNeuroPsychTask',
                      'DiagParkCertain', 'DiagParkPersist', 'DiagParkReplace','Age','Gender','YearsSinceDiag','NpsEducYears',
                      'Up3OfTotal','Up3OfBradySum','Up3OfRigiditySum', 'Up3OfRestTremAmpSum', 'Up3OfCompositeTremorSum',
                      'Up3OnTotal','Up3OnBradySum','Up3OnRigiditySum', 'Up3OnRestTremAmpSum', 'Up3OnCompositeTremorSum',
                      'z_MoCA__total','LEDD',
                      'AsymmetryIndexRiLe.WeightedBradyRig','AsymmetryIndexRiLe.WeightedBradyRig2')
df_clin <- read_clinical_metrics('P:/3022026.01/pep/ClinVars_10-08-2023/derivatives/merged_manipulated_2024-07-17.csv', 
                                 clinical_metrics) %>%
    mutate(MostAffSide=NA,
           MostAffSide = case_when(
               AsymmetryIndexRiLe.WeightedBradyRig2<0 ~ 'L',
               AsymmetryIndexRiLe.WeightedBradyRig2>0 ~ 'R',
               AsymmetryIndexRiLe.WeightedBradyRig2==0 ~ 'Sym',
               .default = NA
               )
           ) %>%
  relocate(MostAffSide, .after = 'Gender')
# This participant has a very peculiar clinical trajectory. At baseline,
# patient presents with extremely high Up3 values in both OFF and ON. Over two
# years, the symptoms decline gradually while medication stays very low. This
# decline is not incremental, it is massive. 20 points drop in two years.
df_clin <- df_clin %>%
        filter(pseudonym != 'sub-POMU0E19B895DF700AB0')
```

```{r MERGE-DATA, echo=F,warning=F,message=F}
# Combine pSN FW, cortical MD, and clinical data
df <- df_clin %>%
  full_join(., df_dti, by = c('pseudonym','ParticipantType','TimepointNr')
            ) %>%
  full_join(., df_fs, by = c('pseudonym','TimepointNr')
            )

baseline_covs <- df %>%
        filter(TimepointNr==0) %>%
        select(pseudonym,ParticipantType,Age,Gender,NpsEducYears,MostAffSide)
df <- df %>% 
        select(-c(Age,Gender,NpsEducYears,MostAffSide)) %>%
        left_join(.,baseline_covs,by=c('pseudonym','ParticipantType')) %>%
        relocate(pseudonym,ParticipantType,Age,Gender,NpsEducYears,MostAffSide)
```

## Feature engineering

We generate a number of new variables:

 - Determine most affected side from motor symptom asymmetry

```{r ENG-ASYM, echo=F,warning=F,message=F}

# Asymmetry indices for pSN FW
df <- df %>%
  mutate(AsymIdxAbs_pSN_avg = abs(R_pSN_avg - L_pSN_avg) / (R_pSN_avg + L_pSN_avg),
         AsymIdxNoAbs_pSN_avg = (R_pSN_avg - L_pSN_avg) / (R_pSN_avg + L_pSN_avg))

# Determine imaging metrics for most and least affected sides
# Remember that left is right and right is left
df <- df %>%
  mutate(
    MAF_pSN_avg = case_when(
      MostAffSide == 'R' ~ L_pSN_avg,
      MostAffSide == 'L' ~ R_pSN_avg,
      .default = NA),
    LAF_pSN_avg = case_when(
      MostAffSide == 'R' ~ R_pSN_avg,
      MostAffSide == 'L' ~ L_pSN_avg,
      .default = NA)
  )
```

 - Calculate deltas

```{r ENG-DELTA, echo=F,warning=F,message=F}
# Add time-specific values as separate columns
add_timepoints_as_columns <- function(dat, id_cols, timevar, var){
  
  # Separate timepoints and calculate delta
  dat2 <- dat %>%
    select(all_of(id_cols),
           all_of(timevar),
           all_of(var)) %>%
    pivot_wider(id_cols = id_cols,
                names_from = 'TimepointNr',
                names_prefix = 'T',
                values_from = all_of(var)) %>%
    mutate(T2sub0 = T2-T0) %>%
    rename()
  
  # Add variable name
  dat2 <- rename_with(
    dat2,
    ~ paste0(.x, '_', var, recycle0 = TRUE),
    starts_with("T")
  )
  
  # Join with old data
  dat <- 
    left_join(dat, dat2, by = c(id_cols))
  
  # Print
  dat

}
id_cols <- colnames(df)[1:2]
timevar <- 'TimepointNr'
vars <- colnames(df)[18:length(colnames(df))]
for(i in 1:length(vars)){
  df <- add_timepoints_as_columns(df, id_cols, timevar, vars[i])
}
```

 - Factorize categorical variables

```{r ENG-FACTOR, echo=F,warning=F,message=F}
# Factorize
df <- df %>%
  mutate(ParticipantType = factor(ParticipantType),
         Gender = factor(Gender),
         TimepointNr = factor(TimepointNr))
```

 - Determine completeness of data per participant

```{r ENG-COMPLETE, echo=F,warning=F,message=F}
# Which subjects have complete data?
subs <- unique(df$pseudonym)
tmp <- c()
for(i in subs){
  ntp <- df %>%
    filter(pseudonym==i) %>%
    select(TimepointNr) %>%
    nrow()
  tmp <- tmp %>%
    bind_rows(tibble(pseudonym=i,ntp=ntp))
}
tmp <- tmp %>%
  mutate(complete_case = if_else(ntp > 1, 1, 0)) %>%
  select(-ntp)
df <- df %>%
  left_join(., tmp, by = 'pseudonym')
  
```

## Exclusions

 - Select only participants who performed the motor task.
 - Exclude misdiagnosed patients
 - Exclude additional participants who did not pass quality control procedures.

```{r EX-MOTOR, echo=F,message=F}
# Only process motor task
df <- df %>%
  filter(MriNeuroPsychTask=='Motor')
```

```{r EX-DIAG, echo=F,message=F}
# Remove misdiagnosed patients
df <- df %>%
  filter(Misdiagnosis != TRUE)

# Remove 
read_dti_exclusions <- function(filename) {
  df <- read_excel(filename) %>%
    filter(retain == 'N') %>%
    select(pseudonym,session) %>%
    distinct() %>%
    mutate(TimepointNr = if_else(str_detect(session,'Visit1'),0,2),
           TimepointNr = factor(TimepointNr),
           Exclusion = 1) %>%
    select(-session)
}
```

```{r EX-QC, echo=F,message=F}
exclusions <- read_dti_exclusions('P:/3024006.02/Analyses/MJF_FreeWater/QC/FW/Exclusions_and_Outliers_FW.xlsx')
df <- df %>%
  left_join(exclusions, by = c('pseudonym','TimepointNr')) %>%
  mutate(Exclusion = if_else(is.na(Exclusion),0,Exclusion)) %>%
  rename(Exclusion_FW = Exclusion)
df_fw <- df %>%
  filter(Exclusion_FW!=1)

exclusions <- read_dti_exclusions('P:/3024006.02/Analyses/MJF_FreeWater/QC/MD/Exclusions_and_Outliers_MD.xlsx')
df <- df %>%
  left_join(exclusions, by = c('pseudonym','TimepointNr')) %>%
  mutate(Exclusion = if_else(is.na(Exclusion),0,Exclusion)) %>%
  rename(Exclusion_MD = Exclusion)
df_md <- df %>%
  filter(Exclusion_MD!=1)

```

## Descriptive statistics

```{r DESC-SUMFUNC, echo=F,warning=F,message=F}
summary_stats_table <- function(dat, vars_group, vars_dv){
  
  # Select data
  dat <- 
    dat %>%
    select(all_of(vars_group), all_of(vars_dv))
  
  # Group data iteratively
  for(i in 1:length(vars_group)){
    dat <- 
      dat %>%
      group_by(.data[[vars_group[i]]], .add = T)
  }
  
  # Initialize data frame
  stats <-
    tibble(
      n = numeric(),
      avg = numeric(),
      sd = numeric(),
      se = numeric(),
      ci.lwr = numeric(),
      ci.upr = numeric(),
      dv = character()
    )
  # Add descriptives for every dv
  for(i in 1:length(vars_dv)){
    row <- 
      dat %>%
      summarise(n=n(),
                avg = mean(.data[[vars_dv[i]]],na.rm=T),
                sd = sd(.data[[vars_dv[i]]],na.rm=T),
                se = sd / sqrt(n), 
                ci.lwr = avg - 1.96*se,
                ci.upr = avg + 1.96*se) %>%
      ungroup() %>%
      mutate(dv = vars_dv[i])
    
    stats <- 
      stats %>%
      bind_rows(row)

  }
  
  # Print
  stats
  
}
```

### Free water

```{r DESC-FW, echo=F,warning=F,message=F}

vars_group <- c('ParticipantType','TimepointNr')
vars_dv <- c('pSN_avg', 'aSN_avg')

# Values per timepoint with error, separated by group
stats_tab <- 
  summary_stats_table(df_fw, vars_group, vars_dv)
g <- ggplot(stats_tab, aes(x = avg, y = dv, color = ParticipantType)) +
  geom_point() + 
  geom_errorbarh(aes(xmin = ci.lwr, xmax = ci.upr)) + 
  facet_wrap(~ParticipantType+TimepointNr,ncol=2,nrow=2) +
  theme_bw() + 
  theme(legend.position = 'none')
print(g)

# Main plot: Deltas per region with error
vars_dv_delta <- paste0('T2sub0_', vars_dv)
stats_delta_tab <- 
  summary_stats_table(df_fw %>% filter(TimepointNr==0), vars_group, vars_dv_delta) %>%
  mutate(dv = str_replace(dv,'T2sub0_',''))

g <- ggplot(stats_delta_tab, aes(x = avg, y = dv, color = ParticipantType)) + 
  geom_vline(xintercept = 0, lty = 2) +
  geom_point() + 
  geom_errorbarh(aes(xmin = ci.lwr, xmax = ci.upr)) + 
  facet_grid(~ParticipantType) +
  theme_bw() +
  theme(legend.position = 'none') + 
  ylab('Region') + 
  xlab('Two-year change (delta; Follow-up - Baseline)') + 
  theme_bw() + 
  theme(legend.position = 'none') + 
  ggtitle('Longitudinal change in free water')
print(g)
# save_plot(g, filename = 'P:/3024006.02/Analyses/MJF_FreeWater/vis/fw_errorbar_deltas.png', dpi=300, device='png', base_width = 8)

# Main plot: Boxplots to visualize group differences
  # PD
df.plot <- df_fw %>% 
  select(pseudonym,ParticipantType,TimepointNr,
         all_of(vars_dv)) %>%
  pivot_longer(cols = all_of(vars_dv),
               names_to = 'ROI',
               values_to = 'Value') %>%
  mutate(ROI=factor(ROI,
                    levels=vars_dv,
                    labels=vars_dv),
         ParticipantType = factor(ParticipantType),
         TimepointNr = factor(TimepointNr)) %>%
  na.omit()

g <- ggplot(df.plot, aes(y=Value, x=ParticipantType, fill=TimepointNr)) + 
  geom_boxplot() + 
  facet_grid(~ROI) +
  theme_bw() +
  ylab('Free water (fraction)') + xlab('') +
  scale_fill_viridis_d(option='mako', begin = .7, end = .5,
                        direction = 1, labels=c('BA','2Y'),
                       guide = guide_legend(title='Time'))
print(g)
# save_plot(g, filename = 'P:/3024006.02/Analyses/MJF_FreeWater/vis/fw_box_HcVsPd.png', dpi=300, device='png', base_width = 7)

# Count of participants
df.plot %>%
  filter(ROI == 'pSN_avg') %>%
  count(ParticipantType,TimepointNr) %>%
  print()

# Main plot: Individual trajectories
delta_vals <- df_fw %>% 
  select(pseudonym,ParticipantType,TimepointNr,
         all_of(vars_dv_delta)) %>%
  pivot_longer(cols = all_of(vars_dv_delta),
               names_to = 'ROI',
               values_to = 'Delta') %>%
  mutate(ROI=factor(ROI,
                    levels=vars_dv_delta,
                    labels=vars_dv),
         ParticipantType = factor(ParticipantType),
         TimepointNr = factor(TimepointNr))
df.plot <- left_join(df.plot, delta_vals, by = c('pseudonym','ParticipantType','TimepointNr','ROI'))

g <- df.plot %>%
  filter(ROI == 'pSN_avg') %>%
  ggplot(., aes(y=Value, x = as.numeric(TimepointNr))) + 
  geom_point(alpha=.3) + 
  geom_line(aes(group = pseudonym, color = Delta), alpha=.3) + 
  geom_smooth(method = 'lm', color = 'black') +
  facet_wrap(~ROI+ParticipantType, ncol = 2, nrow = 1) +
  scale_color_viridis_c(option = 'inferno', begin=0.0,end=0.8)
print(g)

# Main plot: Boxplot of deltas
g <- df.plot %>%
  filter(TimepointNr==0) %>%
  ggplot(aes(y=Delta, x=ParticipantType, fill=ROI)) + 
  geom_boxplot() + 
  facet_grid(~ROI) +
  theme_bw() +
  ylab('Free water delta (fraction)') + xlab('') +
  scale_fill_viridis_d(option='mako', begin = .9, end = .1,
                        direction = 1,
                       guide = guide_legend(title='ROI'))
print(g)

# Checking for outliers
df.plot %>% filter(ROI=='pSN_avg', ParticipantType=='Patient') %>% arrange(-Value) %>% print(n=20)
df.plot %>% filter(ROI=='pSN_avg', ParticipantType=='Patient') %>% arrange(Delta) %>% print(n=20)
df.plot %>% filter(ROI=='pSN_avg', ParticipantType=='Patient') %>% arrange(-Delta) %>% print(n=20)

df.plot %>% filter(ROI=='pSN_avg', ParticipantType=='Healthy') %>% arrange(-Value) %>% print(n=20)
df.plot %>% filter(ROI=='pSN_avg', ParticipantType=='Healthy') %>% arrange(Delta) %>% print(n=20)
df.plot %>% filter(ROI=='pSN_avg', ParticipantType=='Healthy') %>% arrange(-Delta) %>% print(n=20)
```

### Surface-based MD

```{r DESC-SURF, echo=F,warning=F,message=F}

vars_group <- c('ParticipantType','TimepointNr')
# Selecting parieto-premotor regions of interest
labels <- c('inferiorparietal','superiorparietal','precuneus','supramarginal',
            'paracentral','postcentral','precentral','superiorfrontal','caudalmiddlefrontal')
measure <- c('dti')
hemi <- c('bi')
vars_dv <- paste(hemi,labels,measure,sep='_')

# Values per timepoint with error, separated by group
stats_tab <- 
  summary_stats_table(df_md, vars_group, vars_dv)
g <- ggplot(stats_tab, aes(x = avg, y = dv, color = ParticipantType)) +
  geom_point() + 
  geom_errorbarh(aes(xmin = ci.lwr, xmax = ci.upr)) + 
  facet_wrap(~ParticipantType+TimepointNr,ncol=2,nrow=2) +
  theme_bw() + 
  theme(legend.position = 'none')
print(g)

# Main plot: Deltas per region with error
vars_dv_delta <- paste0('T2sub0_', vars_dv)
stats_delta_tab <- 
  summary_stats_table(df_md %>% filter(TimepointNr==0), vars_group, vars_dv_delta) %>%
  mutate(dv = str_replace(dv,'T2sub0_',''))

g <- ggplot(stats_delta_tab, aes(x = avg, y = dv, color = ParticipantType)) + 
  geom_vline(xintercept = 0, lty = 2) +
  geom_point() + 
  geom_errorbarh(aes(xmin = ci.lwr, xmax = ci.upr)) + 
  facet_grid(~ParticipantType) +
  theme_bw() +
  theme(legend.position = 'none') + 
  ylab('Region') + 
  xlab('Two-year change (delta; Follow-up - Baseline)') + 
  theme_bw() + 
  theme(legend.position = 'none') + 
  ggtitle('Longitudinal change in cortical MD')
print(g)
# save_plot(g, filename = 'P:/3024006.02/Analyses/MJF_FreeWater/vis/cortMD_errorbar_deltas.png', dpi=300, device='png', base_width = 8)

# Main plot: Boxplots to visualize group differences
  # PD
df.plot <- df_md %>% 
  select(pseudonym,ParticipantType,TimepointNr,
         all_of(vars_dv)) %>%
  pivot_longer(cols = all_of(vars_dv),
               names_to = 'ROI',
               values_to = 'Value') %>%
  mutate(ROI=factor(ROI,
                    levels=vars_dv,
                    labels=vars_dv),
         ParticipantType = factor(ParticipantType),
         TimepointNr = factor(TimepointNr)) %>%
  na.omit()

g <- ggplot(df.plot, aes(y=Value, x=ParticipantType, fill=TimepointNr)) + 
  geom_boxplot() + 
  facet_grid(~ROI) +
  theme_bw() +
  ylab('Cortical MD') + xlab('') +
  scale_fill_viridis_d(option='mako', begin = .7, end = .5,
                        direction = 1, labels=c('BA','2Y'),
                       guide = guide_legend(title='Time'))
print(g)
# save_plot(g, filename = 'P:/3024006.02/Analyses/MJF_FreeWater/vis/cortMD_box_HcVsPd.png', dpi=300, device='png', base_width = 7)

# Count of participants
df.plot %>%
  filter(ROI == 'bi_inferiorparietal_dti') %>%
  count(ParticipantType,TimepointNr) %>%
  print()

# Main plot: Individual trajectories
delta_vals <- df_md %>% 
  select(pseudonym,ParticipantType,TimepointNr,
         all_of(vars_dv_delta)) %>%
  pivot_longer(cols = all_of(vars_dv_delta),
               names_to = 'ROI',
               values_to = 'Delta') %>%
  mutate(ROI=factor(ROI,
                    levels=vars_dv_delta,
                    labels=vars_dv),
         ParticipantType = factor(ParticipantType),
         TimepointNr = factor(TimepointNr))
df.plot <- left_join(df.plot, delta_vals, by = c('pseudonym','ParticipantType','TimepointNr','ROI'))

g <- df.plot %>%
  filter(ROI == 'bi_caudalmiddlefrontal_dti') %>%
  ggplot(., aes(y=Value, x = as.numeric(TimepointNr))) + 
  geom_point(alpha=.3) + 
  geom_line(aes(group = pseudonym, color = Delta), alpha=.3) + 
  geom_smooth(method = 'lm', color = 'black') +
  facet_wrap(~ROI+ParticipantType, ncol = 2, nrow = 1) +
  scale_color_viridis_c(option = 'inferno', begin=0.0,end=0.8)
print(g)

# Main plot: Boxplot of deltas
g <- df.plot %>%
  filter(TimepointNr==0) %>%
  ggplot(aes(y=Delta, x=ParticipantType, fill=ROI)) + 
  geom_boxplot() + 
  facet_grid(~ROI) +
  theme_bw() +
  ylab('Mean diffusivity (delta)') + xlab('') +
  scale_fill_viridis_d(option='mako', begin = .9, end = .1,
                        direction = 1,
                       guide = guide_legend(title='ROI'))
print(g)

# Checking for outliers
df.plot %>% filter(ROI=='bi_inferiorparietal_dti', ParticipantType=='Patient') %>% arrange(Value) %>% print(n=20)
df.plot %>% filter(ROI=='bi_inferiorparietal_dti', ParticipantType=='Patient') %>% arrange(-Value) %>% print(n=20)
df.plot %>% filter(ROI=='bi_inferiorparietal_dti', ParticipantType=='Patient') %>% arrange(Delta) %>% print(n=20)
df.plot %>% filter(ROI=='bi_inferiorparietal_dti', ParticipantType=='Patient') %>% arrange(-Delta) %>% print(n=20)

df.plot %>% filter(ROI=='bi_inferiorparietal_dti', ParticipantType=='Healthy') %>% arrange(Value) %>% print(n=20)
df.plot %>% filter(ROI=='bi_inferiorparietal_dti', ParticipantType=='Healthy') %>% arrange(-Value) %>% print(n=20)
df.plot %>% filter(ROI=='bi_inferiorparietal_dti', ParticipantType=='Healthy') %>% arrange(Delta) %>% print(n=20)
df.plot %>% filter(ROI=='bi_inferiorparietal_dti', ParticipantType=='Healthy') %>% arrange(-Delta) %>% print(n=20)

```

## Longitudinal change (FW)

Linear mixed-effects modelling of PD-related effects on longitudinal change in posterior and anterior substantia nigra free water.

### Healthy vs Patient: Avg FW

```{r STATS-FW-GROUP, echo=F,warning=F,message=F}
outcome <- c('pSN_avg', 'aSN_avg')
df.long <- df_fw %>%
  select(pseudonym, ParticipantType, TimepointNr, Age, Gender, NpsEducYears, all_of(outcome)) %>%
  pivot_longer(cols = all_of(outcome),
               names_to = 'Variable',
               values_to = 'Val')
n <- df.long %>%
        filter(Variable=='pSN_avg') %>%
        count(ParticipantType,TimepointNr)

test_groupxtime <- function(data, outcome){
  print(paste0('>>>>> ', outcome))
  f <- paste0('log(Val) ~ ParticipantType*TimepointNr + Age + Gender + NpsEducYears + (1|pseudonym)')
  tmp <- data %>%
    filter(Variable==outcome) %>%
    na.omit()
  n <- tmp %>% count(ParticipantType,TimepointNr)
  print(n)
  m <- lmer(f, data = tmp)
  tab_model(m,show.se = T, digits=5)
  a <- Anova(m,type=3)
  print(a)
  kable(a, 'pipe', digits=Inf) %>% print()
  # effectsize::eta_squared(m) %>% print(digits=5)
  
  em <- emmeans(m, ~ TimepointNr|ParticipantType, type='response')
  contrast(em, interaction = c('revpairwise','revpairwise'),
           adjust='mvt', type='response', by=NULL) %>% 
    kable(., 'pipe', digits = Inf, padding=0) %>% print()
  contrast(em, interaction = c('revpairwise','revpairwise'),
           adjust='mvt', type='response') %>% 
    kable(., 'pipe', digits = Inf, padding=0) %>% print()
  # ggemmeans(m, terms=c('TimepointNr','ParticipantType'),
  #           back.transform = TRUE) %>% 
  #   plot(connect.lines=TRUE) %>% plot()
}
for(i in outcome){
  test_groupxtime(df.long, i)
}

g <- df.long %>%
        filter(Variable=='pSN_avg') %>%
  ggplot(aes(x=ParticipantType, y = Val, color=TimepointNr)) +
  geom_jitter(alpha=0.2, position = position_jitterdodge(jitter.width = 0.2)) +
  geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
  stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5, 
               mapping = aes(group=TimepointNr), position = position_dodge(width=0.8)) +
  theme_bw() + 
  scale_x_discrete(labels=c('Control','PD')) +
  scale_color_viridis_d(option='mako', begin = .1, end = .6,
                        direction = -1) + 
  ggtitle('Posterior substantia nigra') +
  ylab('Free water (fraction)') + xlab('') + 
  guides(color = guide_legend(title='Year')) +
  ylim(0.1, 0.5) + 
  annotate(geom='text',label=paste0('N=',n$n[1]),x=0.8,y=0.1) +
  annotate(geom='text',label=paste0('N=',n$n[2]),x=1.2,y=0.1) +
  annotate(geom='text',label=paste0('N=',n$n[3]),x=1.8,y=0.1) +
  annotate(geom='text',label=paste0('N=',n$n[4]),x=2.2,y=0.1)
y <- 0.47
d = 0.015
segmap <- data.frame(
        x =    c(1.00, 0.80,  1.80, 1.00, 2.00, 0.80, 1.20, 1.80, 2.20, 1.80),
        xend = c(2.00, 1.20,  2.20, 1.00, 2.00, 0.80, 1.20, 1.80, 2.20, 2.20),
        y =    c(y,    y-d,   y-d,  y,    y,    y-d*1,y-d*1,y-d*1,y-d*1, y-d*3),
        yend = c(y,    y-d,   y-d,  y-d*1,y-d*1,y-d*2,y-d*2,y-d*2,y-d*2, y-d*3)
)
sigmap <- data.frame(
        x =     c(1.50, 2.00),
        y =     c(y+0.015,    y-d*3),
        label = c('+', '***')
)
g <- g + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     linewidth = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(g)
# save_plot(g, filename = 'M:/Visualization/R_LongitudinalComparisonFmri/SnFW/FW_pSN_HCvsPD.png', dpi=300, device='png', base_width = 5)
```

### Patients: MAF vs LAF

Linear mixed-effects modelling of lateralization-related effects on longitudinal change in posterior and anterior substantia nigra free water.

```{r STATS-FW-SIDE, echo=F,warning=F,message=F}

mafdat <- df_fw %>%
    filter(ParticipantType == 'Patient') %>%
    select(pseudonym,TimepointNr,Age,Gender,NpsEducYears,YearsSinceDiag,MAF_pSN_avg,LAF_pSN_avg) %>%
    pivot_longer(cols = c('MAF_pSN_avg','LAF_pSN_avg'),
                 names_to = 'Lateralization',
                 values_to = 'FW') %>%
  mutate(Lateralization = factor(Lateralization,
                                 levels=c('LAF_pSN_avg','MAF_pSN_avg'),
                                 labels=c('Least','Most'))) %>%
  na.omit()
n <- mafdat %>%
        count(TimepointNr,Lateralization)

m <- mafdat %>%
    lmer(log(FW) ~ TimepointNr*Lateralization + Age + Gender + NpsEducYears + YearsSinceDiag + (1+Lateralization|pseudonym), data = .)
Anova(m,type=3) %>% print(digits=7)
ggemmeans(m, c('TimepointNr','Lateralization')) %>% plot(connect.lines=T) %>% print()

em <- emmeans(m, ~TimepointNr | Lateralization, type = 'response')
contrast(em, interaction = c('revpairwise','revpairwise'), by = NULL) %>% kable(., 'pipe', digits=Inf)
contrast(em, interaction = c('revpairwise','revpairwise')) %>% kable(., 'pipe', digits=Inf)
contrast(em, interaction = c('revpairwise','revpairwise'), by = 'TimepointNr') %>% kable(., 'pipe', digits=Inf)
em <- emmeans(m, ~ TimepointNr, type='response')
contrast(em, interaction = c('revpairwise')) %>% kable(., 'pipe', digits = Inf, padding=0) %>% print()
em <- emmeans(m, ~ Lateralization, type='response')
contrast(em, interaction = c('revpairwise')) %>% kable(., 'pipe', digits = Inf, padding=0) %>% print()


g <- mafdat %>%
  ggplot(aes(x=Lateralization, y = FW, color=TimepointNr)) +
  geom_jitter(alpha=0.2, position = position_jitterdodge(jitter.width = 0.2)) +
  geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
  stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5, 
               mapping = aes(group=TimepointNr), position = position_dodge(width=0.8)) +
  theme_bw() + 
  scale_x_discrete(labels=c('Least','Most')) +
  scale_color_viridis_d(option='mako', begin = .1, end = .6,
                        direction = -1) + 
  ggtitle('') +
  ylab('Free water (fraction)') + xlab('Most affected side') + ggtitle('') +
  guides(color = guide_legend(title='Year')) +
  ylim(0.05, 0.5) + 
  annotate(geom='text',label=paste0('N=',n$n[1]),x=0.8,y=0.05) +
  annotate(geom='text',label=paste0('N=',n$n[3]),x=1.2,y=0.05) +
  annotate(geom='text',label=paste0('N=',n$n[2]),x=1.8,y=0.05) +
  annotate(geom='text',label=paste0('N=',n$n[4]),x=2.2,y=0.05)
y <- 0.5
d = 0.02
segmap <- data.frame(
        x =    c(1.00, 0.80,  1.80),
        xend = c(2.00, 1.20,  2.20),
        y =    c(y,    y-d,   y-d),
        yend = c(y,    y-d,   y-d)
)
sigmap <- data.frame(
        x =     c(1.50, 1.00,  2.00),
        y =     c(y,    y-d*1, y-d*1),
        label = c('***', '**','**')
)
g <- g + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     linewidth = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(g)
# save_plot(g, filename = 'P:/3024006.02/Analyses/MJF_FreeWater/vis/fw_final_MAFvsLAF.png', dpi=300, device='png', base_width = 5)
```

Test of lateralization differences at each separate time point.

```{r, echo=F,warning=F,message=F}
# At each separate visit
for(i in c(0,2)){
        print(paste0('>>> Analzying timepoint ', i))
        m <- mafdat %>%
                filter(TimepointNr==i) %>%
                lm(log(FW) ~ Lateralization + Age + Gender + NpsEducYears + YearsSinceDiag, data = .)
        Anova(m, type=3) %>% print()
        tab_model(m,show.se=T,digits = 5)
        eta_squared(m) %>% print(digits=5)
}

```

## Clinical correlations (FW)

### Bradykinesia: baseline and follow-up

```{r STAT-FW-CORR-BRADY, echo=F,warning=F,message=F}
corrdat <- df_fw %>%
    filter(ParticipantType=='Patient')

# Bradykinesia severity
# Baseline
print('>>> Baseline: On-state bradykinesia vs pSN FW')
g <- df_fw %>%
    filter(ParticipantType=='Patient',
           TimepointNr==0) %>%
    ggplot(aes(x=Up3OnBradySum,y=pSN_avg)) + 
    geom_point() + 
    geom_smooth(method='lm')
print(g)
m <- corrdat %>%
  filter(TimepointNr==0) %>%
  lm(log(aSN_avg) ~ Up3OnBradySum + Age + Gender + NpsEducYears + YearsSinceDiag, data = .)
Anova(m,type=3) %>% print()
summary(m) %>% print()
# Follow-up
print('>>> Follow-up: On-state bradykinesia vs pSN FW')
g <- df_fw %>%
    filter(ParticipantType=='Patient',
           TimepointNr==2) %>%
    ggplot(aes(x=Up3OnBradySum,y=pSN_avg)) + 
    geom_point() + 
    geom_smooth(method='lm')
print(g)
m <- corrdat %>%
  filter(TimepointNr==2) %>%
  lm(log(aSN_avg) ~ Up3OnBradySum + Age + Gender + NpsEducYears + YearsSinceDiag, data = .)
Anova(m,type=3) %>% print()
summary(m) %>% print()

```

### Motor asymmetry: baseline and follow-up

```{r STAT-FW-CORR-ASYM, echo=F,warning=F,message=F}

# Motor asymmetry
# Baseline
print('>>> Baseline: Asymmetry vs pSN FW')
m <- corrdat %>%
  filter(TimepointNr==0) %>%
  lm(AsymIdxNoAbs_pSN_avg ~ AsymmetryIndexRiLe.WeightedBradyRig2 + Age + Gender + NpsEducYears + YearsSinceDiag, data = .)
tab_model(m, digits=5, show.se=T)
s <- summary(m)
g <- ggemmeans(m, terms = 'AsymmetryIndexRiLe.WeightedBradyRig2') %>% plot(add.data=TRUE,color='darkred') + theme_bw() + 
  ggtitle('Baseline') + xlab('Motor asymetry index') + ylab('Free water asymmetry index') +
  annotate(geom = 'text', x=-1, y=-0.5, hjust=0, 
           label = paste0('N=', length(predict(m)), ', ',
                          'β=', round(s$coefficients[2,1], digits=5),' ,',
                          'SE=', round(s$coefficients[2,2], digits=5), ' ,',
                          'P=', round(s$coefficients[2,4], digits=5))) +
  ylim(-0.5,0.5)
print(g)
# save_plot(g, filename = 'P:/3024006.02/Analyses/MJF_FreeWater/vis/fw_final_asymmetry_ba.png', dpi=300, device='png', base_width = 5)
Anova(m,type=3) %>% print(digits=5)
eta_squared(m) %>% print(digits=5)
# Follow-up
print('>>> Follow-up: Asymmetry vs pSN FW')
m <- corrdat %>%
  filter(TimepointNr==2) %>%
  lm(AsymIdxNoAbs_pSN_avg ~ AsymmetryIndexRiLe.WeightedBradyRig2 + Age + Gender + NpsEducYears + YearsSinceDiag, data = .)
tab_model(m, digits=5, show.se=T)
s <- summary(m)
g <- ggemmeans(m, terms = 'AsymmetryIndexRiLe.WeightedBradyRig2') %>% plot(add.data=TRUE,color='darkred') + theme_bw() + 
  ggtitle('Follow-up') + xlab('Motor asymetry index') + ylab('Free water asymmetry index') +
  annotate(geom = 'text', x=-1, y=-0.5, hjust=0, 
           label = paste0('N=', length(predict(m)), ', ',
                          'β=', round(s$coefficients[2,1], digits=5),' ,',
                          'SE=', round(s$coefficients[2,2], digits=5), ' ,',
                          'P=', round(s$coefficients[2,4], digits=5))) +
  ylim(-0.5,0.5)
print(g)
# save_plot(g, filename = 'P:/3024006.02/Analyses/MJF_FreeWater/vis/fw_final_asymmetry_fu.png', dpi=300, device='png', base_width = 5)
Anova(m,type=3) %>% print(digits=5)
eta_squared(m) %>% print(digits=5)
```

### Bradykinesia: longitudinal (delta)

```{r STAT-FW-DELTACORR-BRADY, echo=F,warning=F,message=F}

deltadat <- df_fw %>%
  filter(ParticipantType=='Patient',
         TimepointNr==0)

# Bradykinesia severity
m <- lm(T2sub0_Up3OnBradySum ~ T2sub0_pSN_avg + T0_Up3OnBradySum + T0_pSN_avg + Age + Gender + NpsEducYears + YearsSinceDiag, data = deltadat)
ggemmeans(m,c('T2sub0_pSN_avg')) %>% plot() %>% print()
g <- deltadat %>%
    ggplot(aes(x=T2sub0_Up3OnBradySum,y=T2sub0_pSN_avg)) + 
    geom_point() + 
    geom_smooth(method='lm',color='black')
plot(g)
tab_model(m, digits=5, show.se=T)
Anova(m,type=3) %>% print()

```

### Motor asymmetry: longitudinal (delta)

```{r STAT-FW-DELTACORR-ASYM, echo=F,warning=F,message=F}
# Motor asymmetry
m <- lm(T2sub0_AsymIdxNoAbs_pSN_avg ~ T2sub0_AsymmetryIndexRiLe.WeightedBradyRig2 + T0_AsymmetryIndexRiLe.WeightedBradyRig2 + T0_AsymIdxNoAbs_pSN_avg + Age + Gender + NpsEducYears + YearsSinceDiag, data = deltadat)
Anova(m,type=3)
summary(m)
ggemmeans(m,'T2sub0_AsymmetryIndexRiLe.WeightedBradyRig2') %>% plot() %>% print()
g <- deltadat %>%
    ggplot(aes(x=T2sub0_AsymmetryIndexRiLe.WeightedBradyRig2,y=T2sub0_AsymIdxNoAbs_pSN_avg)) + 
    geom_point() + 
    geom_smooth(method='lm',color='black')
plot(g)
tab_model(m, digits=5, show.se=T)
Anova(m,type=3) %>% print()
```

### LEDD: baseline and follow-up

```{r STAT-FW-SESCORR-BRADY, echo=F,warning=F,message=F}
# Baseline
print('>>> Baseline: LEDD vs pSN FW')
g <- df_fw %>%
    filter(ParticipantType=='Patient',
           TimepointNr==0) %>%
    ggplot(aes(x=LEDD,y=pSN_avg)) + 
    geom_point() + 
    geom_smooth(method='lm')
print(g)
m <- corrdat %>%
  filter(TimepointNr==0) %>%
  lm(log(pSN_avg) ~ LEDD + Age + Gender + NpsEducYears + YearsSinceDiag, data = .)
tab_model(m, digits=5, show.se=T)
Anova(m,type=3) %>% print()
# Follow-up
print('>>> Follow-up: LEDD vs pSN FW')
g <- df_fw %>%
    filter(ParticipantType=='Patient',
           TimepointNr==2) %>%
    ggplot(aes(x=LEDD,y=pSN_avg)) + 
    geom_point() + 
    geom_smooth(method='lm')
print(g)
m <- corrdat %>%
  filter(TimepointNr==2) %>%
  lm(log(pSN_avg) ~ LEDD + Age + Gender + NpsEducYears + YearsSinceDiag, data = .)
tab_model(m, digits=5, show.se=T)
Anova(m,type=3) %>% print()
```

### LEDD: longitudinal (delta)

```{r STAT-FW-DELTACORR-LEDD, echo=F,warning=F,message=F}

deltadat <- df_fw %>%
  filter(ParticipantType=='Patient',
         TimepointNr==0)
m <- lm(T2sub0_LEDD ~ T2sub0_pSN_avg + T0_LEDD + T0_pSN_avg + Age + Gender + NpsEducYears + YearsSinceDiag, data = deltadat)
ggemmeans(m,c('T2sub0_pSN_avg')) %>% plot() %>% print()
g <- deltadat %>%
    ggplot(aes(x=T2sub0_LEDD,y=T2sub0_pSN_avg)) + 
    geom_point() + 
    geom_smooth(method='lm',color='black')
plot(g)
tab_model(m, digits=5, show.se=T)
Anova(m,type=3) %>% print()

```

## Write FW values for FSL covariate analysis

This section should be run manually.

```{r WRITE-COVAR, echo=F,warning=F,message=F,eval=F}

cons <- c('con_0007', 'con_0010')

for(i in cons){
  
  pth <- paste0('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/data/', i, '/imgs__delta_clincorr.txt')
  pths <- read_csv(pth, col_names = c('paths')) %>%
    mutate(pseudonym = str_sub(paths, start = 72, end = 95))
  
  # Free water covariate
  fsl_covs <-
    df_fw %>%
    filter(ParticipantType=='Patient') %>%
    select(pseudonym, TimepointNr, pSN_avg) %>%
    pivot_wider(id_cols = 'pseudonym',
                names_from = 'TimepointNr',
                names_prefix = 'T',
                values_from = 'pSN_avg') %>%
    mutate(pSN_Delta = T2-T0,
           across(where(is.numeric), \(x) round(x, 5))) %>%
    rename(pSN_T0 = T0) %>%
    select(-T2) %>%
    relocate(pseudonym, pSN_Delta, pSN_T0)
  
  fsl_covs <- pths %>%
    left_join(fsl_covs, by = 'pseudonym')
  
  outpth <- paste0('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/data/', i, '/covs__delta_pSN_FW.csv')
  # write_csv(fsl_covs, outpth)
  
  # Mean diffusivity covariate
  fsl_covs <-
    df_md %>%
    filter(ParticipantType=='Patient') %>%
    select(pseudonym, TimepointNr, bi_caudalmiddlefrontal_dti) %>%
    pivot_wider(id_cols = 'pseudonym',
                names_from = 'TimepointNr',
                names_prefix = 'T',
                values_from = 'bi_caudalmiddlefrontal_dti') %>%
    mutate(cmf_Delta = T2-T0,
           across(where(is.numeric), \(x) round(x, 5))) %>%
    rename(cmf_T0 = T0) %>%
    select(-T2) %>%
    relocate(pseudonym, cmf_Delta, cmf_T0)

  fsl_covs <- pths %>%
    left_join(fsl_covs, by = 'pseudonym')

  outpth <- paste0('P:/3024006.02/Analyses/motor_task/Group/Longitudinal/FSL/data/', i, '/covs__delta_caudalmiddlefrontal_MD.csv')
  # write_csv(fsl_covs, outpth)
  
}

```

## FreeSurfer metrics

```{r FS-METRICS, echo=F,warning=F,message=F}

# Write data for plotting purposes
write_csv(df_md,'P:/3024006.02/wd/ggseg_all_data.csv')

# Group x Time comparisons, 1 observation per time point
labels <- c('caudalmiddlefrontal','inferiorparietal','paracentral','postcentral','precentral','precuneus',
            'superiorfrontal','superiorparietal','supramarginal')
measure <- c('dti')
hemi <- c('bi')
cols <- paste(hemi,labels,measure,sep='_')

plot_dat <- df_md %>%
  select(pseudonym,ParticipantType,TimepointNr,
         all_of(cols)) %>%
  pivot_longer(cols = all_of(cols),
               names_to = 'region',
               values_to = 'metric')
plot_dat %>%
  ggplot(aes(x=factor(region),y=metric,fill=TimepointNr)) + 
  geom_boxplot() + 
  facet_wrap(~ParticipantType) +
  theme_bw() + 
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

tab <- c()
tab2 <- c()
for(lab in labels){
  
        print(paste0('>>> Region: ', lab))
        
  # Variables to use
  dv <- paste0(hemi,'_',lab, '_', measure)
  dv_delta <- paste0('T2sub0_',dv)
  dv_t0 <- paste0('T0_',dv)
  dv_t2 <- paste0('T2_',dv)
  iv_thick_ba <- paste0('T0_',str_replace(dv,'dti','thickavg'))
  iv_thick_fu <- paste0('T2_',str_replace(dv,'dti','thickavg'))
  iv_thick_delta <- paste0('T2sub0_',str_replace(dv,'dti','thickavg'))
  
  tmp <- df_md %>% select(pseudonym,ParticipantType,TimepointNr,Age,Gender,NpsEducYears,all_of(dv)) %>% na.omit()
  tmp %>% count(ParticipantType,TimepointNr) %>% print()
  
  # Group comparisons
  # With thickness covariate
  # f <- paste0('log(', dv, ') ~ ParticipantType*TimepointNr + Age + Gender + NpsEducYears + ', iv_thick_delta,'+',iv_thick_ba, ' + (1|pseudonym)')
  # Without thickness covariate
  f <- paste0('log(', dv, ') ~ ParticipantType*TimepointNr + Age + Gender + NpsEducYears + (1|pseudonym)')
  m <- lmer(f, tmp, weights = NULL)
  tab_model(m,show.se = T, digits=5)
  a <- Anova(m,type=3)
  print(a, digits = 5)
  eta_squared(m) %>% print(digits = 5)
  em <- emmeans(m, ~ TimepointNr|ParticipantType, type='response')
  contrast(em, interaction = c('revpairwise','revpairwise'),
           adjust='mvt', type='response', by=NULL) %>% 
    kable(., 'pipe', digits = 7, padding=0) %>% print()
  contrast(em, interaction = c('revpairwise','revpairwise'),
           adjust='mvt', type='response') %>% 
    kable(., 'pipe', digits = 7, padding=0) %>% print()
  
  # Correlations
  pcor_dat <- df_md %>%
    filter(ParticipantType=='Patient',
           TimepointNr==0,
           complete_case == 1) %>%
    rename(T0_Up3BradySum=T0_Up3OnBradySum, T2sub0_Up3BradySum=T2sub0_Up3OnBradySum) %>%
    select(pseudonym,all_of(dv_delta),all_of(dv_t0),
           T0_Up3BradySum,T2sub0_Up3BradySum,
           T0_z_MoCA__total,T2sub0_z_MoCA__total,
           T0_LEDD,T2sub0_LEDD,
           all_of(c(iv_thick_ba,iv_thick_delta)),
           Age,NpsEducYears,Gender,YearsSinceDiag) %>%
    na.omit()
  print(paste0('>>> Number of participants: ', pcor_dat %>% nrow() %>% print()))
  
  # Symptom-specific correlations
  # With thickness covariate
  # m_delta <- lm(paste0(dv_delta, '~', dv_t0, 
  #                      '+T2sub0_Up3BradySum+T0_Up3BradySum+T2sub0_z_MoCA__total+T0_z_MoCA__total+T2sub0_LEDD+T0_LEDD+Age+Gender+NpsEducYears+YearsSinceDiag+',
  #                      iv_thick_delta,'+',iv_thick_ba), data = pcor_dat)
  # Without thickness covariate
   m_delta <- lm(paste0(dv_delta, '~', dv_t0, 
                       '+T2sub0_Up3BradySum+T0_Up3BradySum+
                       T2sub0_z_MoCA__total+T0_z_MoCA__total+
                       T2sub0_LEDD+T0_LEDD+
                       Age+Gender+NpsEducYears+YearsSinceDiag'), data = pcor_dat)
  s_delta <- summary(m_delta)
  print('>>>>>>>>>>>>>>>>>>>>>>>>>>>>')
  print(s_delta, digits = 7)
  print(Anova(eval(s_delta$call),type=3), digits = 7)
  print('>>>>>>>>>>>>>>>>>>>>>>>>>>>>')
  
  # Non-specific correlations
  m_delta_brady <- lm(paste0(dv_delta, '~', dv_t0, 
                       '+T2sub0_Up3BradySum+T0_Up3BradySum+
                       Age+Gender+NpsEducYears+YearsSinceDiag'), data = pcor_dat)
  s_delta_brady <- summary(m_delta_brady)
  m_delta_moca <- lm(paste0(dv_delta, '~', dv_t0, 
                       '+T2sub0_z_MoCA__total+T0_z_MoCA__total+
                       Age+Gender+NpsEducYears+YearsSinceDiag'), data = pcor_dat)
  s_delta_moca <- summary(m_delta_moca)
  m_delta_ledd <- lm(paste0(dv_delta, '~', dv_t0, 
                       '+T2sub0_LEDD+T0_LEDD+
                       Age+Gender+NpsEducYears+YearsSinceDiag'), data = pcor_dat)
  s_delta_ledd <- summary(m_delta_ledd)
  
  # Time-specific correlations
    # T0
  tcor_dat_t0 <- df_md %>%
    filter(ParticipantType=='Patient',
           TimepointNr==0) %>%
    rename(T0_Up3BradySum=T0_Up3OnBradySum) %>%
    select(pseudonym,all_of(dv_t0),
           T0_Up3BradySum,
           T0_z_MoCA__total,
           all_of(c(iv_thick_ba)),
           Age,NpsEducYears,Gender,YearsSinceDiag) %>%
    na.omit()
  s_ba_all <- lm(paste0('log(',dv_t0, ')~T0_Up3BradySum+T0_z_MoCA__total+Age+Gender+NpsEducYears+YearsSinceDiag'), data = tcor_dat_t0) %>% summary()
  print('>>>>>>>>>>>>>>>>>>>>>>>>>>>>')
  print(s_ba_all, digits = 7)
  print(Anova(eval(s_ba_all$call),type=3), digits = 7)
  print('>>>>>>>>>>>>>>>>>>>>>>>>>>>>')
  s_ba_brady <- lm(paste0('log(',dv_t0, ')~T0_Up3BradySum+Age+Gender+NpsEducYears+YearsSinceDiag'), data = tcor_dat_t0) %>% summary()
  s_ba_moca <- lm(paste0('log(',dv_t0, ')~T0_z_MoCA__total+Age+Gender+NpsEducYears+YearsSinceDiag'), data = tcor_dat_t0) %>% summary()
    # T2
  tcor_dat_t2 <- df_md %>%
    filter(ParticipantType=='Patient',
           TimepointNr==2) %>%
    rename(T2_Up3BradySum=T2_Up3OnBradySum) %>%
    select(pseudonym,all_of(dv_t2),
           T2_Up3BradySum,
           T2_z_MoCA__total,
           all_of(c(iv_thick_fu)),
           Age,NpsEducYears,Gender,YearsSinceDiag) %>%
    na.omit()
  s_fu_all <- lm(paste0('log(',dv_t2, ')~T2_Up3BradySum+T2_z_MoCA__total+Age+Gender+NpsEducYears+YearsSinceDiag'), data = tcor_dat_t2) %>% summary()
  print('>>>>>>>>>>>>>>>>>>>>>>>>>>>>')
  print(s_fu_all, digits = 7)
  print(Anova(eval(s_fu_all$call),type=3), digits = 7)
  print('>>>>>>>>>>>>>>>>>>>>>>>>>>>>')
  s_fu_brady <- lm(paste0('log(',dv_t2, ')~T2_Up3BradySum+Age+Gender+NpsEducYears+YearsSinceDiag'), data = tcor_dat_t2) %>% summary()
  s_fu_moca <- lm(paste0('log(',dv_t2, ')~T2_z_MoCA__total+Age+Gender+NpsEducYears+YearsSinceDiag'), data = tcor_dat_t2) %>% summary()
  
  # RM correlations
  rcor_dat <- df_md %>%
    filter(ParticipantType=='Patient',
           complete_case==1) %>%
    rename(Up3BradySum=Up3OfBradySum)
  rmc_brady <- rmcorr('pseudonym',dv,'Up3BradySum',dataset = rcor_dat)
  rmc_moca <- rmcorr('pseudonym',dv,'z_MoCA__total',dataset = rcor_dat)
  rmc_ledd <- rmcorr('pseudonym',dv,'LEDD',dataset = rcor_dat)
  
  # Cohen's d
  d <- df_md %>%
    filter(TimepointNr==0) %>%
    select(all_of(dv_delta),ParticipantType) %>%
    na.omit() %>%
    effectsize::cohens_d(dv_delta,'ParticipantType',data=.,pooled_sd = F)
  # Eta squared
  eta <- effectsize::eta_squared(m)
  
  tab <- bind_rows(tab,
                   tibble(label=dv,
                          p_Group_x_Time=a[rownames(a)=='ParticipantType:TimepointNr',3],
                          p_Time=a[rownames(a)=='TimepointNr',3],
                          p_Group=a[rownames(a)=='ParticipantType',3],
                          cohens_d=d$Cohens_d,
                          eta_squared=eta$Eta2_partial[eta$Parameter=='ParticipantType:TimepointNr'],
                          p_brady_delta=s_delta$coefficients[rownames(s_delta$coefficients)=='T2sub0_Up3BradySum',4],
                          p_bradyOnly_delta=s_delta_brady$coefficients[rownames(s_delta_brady$coefficients)=='T2sub0_Up3BradySum',4],
                          p_brady_rmc=rmc_brady$p,
                          p_moca_delta=s_delta$coefficients[rownames(s_delta$coefficients)=='T2sub0_z_MoCA__total',4],
                          p_mocaOnly_delta=s_delta_moca$coefficients[rownames(s_delta_moca$coefficients)=='T2sub0_z_MoCA__total',4],
                          p_moca_rmc=rmc_moca$p,
                          p_ledd_delta=s_delta$coefficients[rownames(s_delta$coefficients)=='T2sub0_LEDD',4],
                          p_leddOnly_delta=s_delta_ledd$coefficients[rownames(s_delta_ledd$coefficients)=='T2sub0_LEDD',4],
                          p_ledd_rmc=rmc_ledd$p)
  )
  tab2 <- bind_rows(tab2,
                   tibble(label=dv,
                          p_all_brady_ba=s_ba_all$coefficients[rownames(s_ba_all$coefficients)=='T0_Up3BradySum',4],
                          p_ba_brady=s_ba_brady$coefficients[rownames(s_ba_brady$coefficients)=='T0_Up3BradySum',4],
                          p_all_brady_fu=s_fu_all$coefficients[rownames(s_fu_all$coefficients)=='T2_Up3BradySum',4],
                          p_fu_brady=s_fu_brady$coefficients[rownames(s_fu_brady$coefficients)=='T2_Up3BradySum',4],
                          p_all_moca_ba=s_ba_all$coefficients[rownames(s_ba_all$coefficients)=='T0_z_MoCA__total',4],
                          p_ba_moca=s_ba_moca$coefficients[rownames(s_ba_moca$coefficients)=='T0_z_MoCA__total',4],
                          p_all_moca_fu=s_fu_all$coefficients[rownames(s_fu_all$coefficients)=='T2_z_MoCA__total',4],
                          p_mocaOnly_fu=s_fu_moca$coefficients[rownames(s_fu_moca$coefficients)=='T2_z_MoCA__total',4])
  )
}

print(tab)
print(paste0('>>> FDR-corrected GROUP x TIME')) 
p.adjust(tab$p_Group_x_Time,method='fdr') %>% round(digits=5)
write_csv(tab,'P:/3024006.02/wd/ggseg_stats_CLINvsMD.csv')
print(tab2)
print(paste0('>>> FDR-corrected BRADYKINESIA (delta)')) 
p.adjust(tab$p_brady_delta,method='fdr') %>% round(digits=5)
print(paste0('>>> FDR-corrected BRADYKINESIA (baseline)')) 
p.adjust(tab2$p_all_brady_ba,method='fdr') %>% round(digits=5)
print(paste0('>>> FDR-corrected BRADYKINESIA (follow-up)')) 
p.adjust(tab2$p_all_brady_fu,method='fdr') %>% round(digits=5)

# Visualization

n <- df_md %>%
  select(ParticipantType,TimepointNr,bi_caudalmiddlefrontal_dti) %>%
  na.omit() %>%
  count(ParticipantType,TimepointNr)

## Caudal middle frontal
g <- df_md %>%
  ggplot(aes(x=ParticipantType, y = bi_caudalmiddlefrontal_dti, color=TimepointNr)) +
  geom_jitter(alpha=0.2, position = position_jitterdodge(jitter.width = 0.2)) +
  geom_boxplot(outlier.shape = NA, width=0.5, position = position_dodge(width=0.8)) + 
  stat_summary(fun.data = 'mean_cl_boot', geom = 'point', color='darkred', size=1.5, 
               mapping = aes(group=TimepointNr), position = position_dodge(width=0.8)) +
  theme_bw() + 
  scale_x_discrete(labels=c('Control','PD')) +
  scale_color_viridis_d(option='mako', begin = .1, end = .6,
                        direction = -1) + 
  ggtitle('') +
  ylab('Mean diffusivity (un-corrected)') + xlab('') + ggtitle('Caudal middle frontal gyrus') +
  guides(color = guide_legend(title='Year')) +
  ylim(0.68, 0.95) + 
  annotate(geom='text',label=paste0('N=',n$n[1]),x=0.8,y=0.68) +
  annotate(geom='text',label=paste0('N=',n$n[2]),x=1.2,y=0.68) +
  annotate(geom='text',label=paste0('N=',n$n[3]),x=1.8,y=0.68) +
  annotate(geom='text',label=paste0('N=',n$n[4]),x=2.2,y=0.68)
y <- 0.95
d = 0.01
segmap <- data.frame(
        x =    c(1.00, 0.80,  1.80, 1.00, 2.00, 0.80, 1.20, 1.80, 2.20, 1.80, 0.80),
        xend = c(2.00, 1.20,  2.20, 1.00, 2.00, 0.80, 1.20, 1.80, 2.20, 2.20, 1.20),
        y =    c(y,    y-d,   y-d,  y,    y,    y-d*1,y-d*1,y-d*1,y-d*1, y-d*3, y-d*3),
        yend = c(y,    y-d,   y-d,  y-d*1,y-d*1,y-d*2,y-d*2,y-d*2,y-d*2, y-d*3, y-d*3)
)
sigmap <- data.frame(
        x =     c(1.50, 1.00,        2.00),
        y =     c(y,    y-d*3, y-d*3),
        label = c('*','***', '***')
)
g <- g + 
        geom_segment(data=segmap,
                     mapping = aes(x=x,xend=xend,y=y,yend=yend),
                     inherit.aes = FALSE,
                     linewidth = lsize) +
        geom_text(data=sigmap, 
                  mapping = aes(x=x,y=y,label=label),
                  inherit.aes = FALSE,
                  size = sigsize)
print(g)
# save_plot(g, filename = 'M:/Visualization/R_LongitudinalComparisonFmri/CorticalMD/cMD_caudalmiddlefrontal_HCvsPD.png', dpi=300, device='png', base_width = 4)

```

## Compensation ~ cortical microstructure

```{r COMPENSATION-CORR, echo=F,warning=F,message=F}

labels <- c('superiorfrontal','caudalmiddlefrontal')
measure <- c('dti')
hemi <- c('bi')
prefix <- c('T2sub0')
cols_T2sub0 <- paste(prefix,hemi,labels,measure,sep='_')
prefix <- c('T0')
cols_T0 <- paste(prefix,hemi,labels,measure,sep='_')

tmp <- df_md %>% 
  filter(ParticipantType=='Patient',
         TimepointNr==0) %>%
  select(pseudonym, ParticipantType, TimepointNr, Age, Gender, NpsEducYears, YearsSinceDiag,
         T2sub0_Up3OnBradySum,T0_Up3OnBradySum,
         all_of(cols_T2sub0),
         all_of(cols_T0),
         all_of(str_replace(cols_T0,'dti','thickavg')),
         all_of(str_replace(cols_T2sub0,'dti','thickavg'))) %>%
  select(-c(ParticipantType,TimepointNr))

tmp <- df_compensation_AddCov0 %>%
  left_join(., tmp, by = c('pseudonym')) %>%
  na.omit()

tab <- c()
for(lab in 1:length(labels)){
  iv_T2sub0 <- cols_T2sub0[lab]
  iv_T0 <- cols_T0[lab]
  iv_thick_ba <- paste0(str_replace(iv_T0,'dti','thickavg'))
  iv_thick_delta <- paste0(str_replace(iv_T2sub0,'dti','thickavg'))
  
  # Parietal comp
  f <- paste0('T2sub0_bi_FEF_comp ~ ', iv_T2sub0, ' + Age + Gender + NpsEducYears + YearsSinceDiag + T0_bi_FEF_comp +',iv_T0)
  m <- lm(f, data = tmp)
  a1 <- Anova(m,type=3)
  print(a1, digits = 5)
  eta_squared(m) %>% print(digits=5)

  g1 <- tmp %>%
    ggplot(aes(x=.data[[iv_T2sub0]],y=T2sub0_bi_FEF_comp)) +
    geom_point() + geom_smooth(method='lm',color='darkred') + theme_bw() +
    ggtitle('Raw values of T2sub0_bi_FEF_comp') +
        geom_hline(yintercept = 0, color = 'darkgrey', lty = 2) + geom_vline(xintercept = 0, color = 'darkgrey', lty = 2)
  pred <- ggpredict(m, terms=iv_T2sub0)
  g2 <- plot(pred, add.data = TRUE) + theme_bw() +
        geom_hline(yintercept = 0, color = 'darkgrey', lty = 2) + geom_vline(xintercept = 0, color = 'darkgrey', lty = 2)
  g <- ggarrange(g1,g2,nrow = 2,ncol = 1)
  print(g)
  
  # Premotor comp
  f <- paste0('T2sub0_R_FEF ~ ', iv_T2sub0, ' + Age + Gender + NpsEducYears + YearsSinceDiag + T0_R_FEF +',iv_T0)
  m <- lm(f, data = tmp)
  a2 <- Anova(m,type=3)
  
  # Parietopremotor comp
  f <- paste0('T2sub0_L_FEF ~ ', iv_T2sub0, ' + Age + Gender + NpsEducYears + YearsSinceDiag + T0_L_FEF +',iv_T0)
  m <- lm(f, data = tmp)
  a3 <- Anova(m,type=3)
  
  tab <- bind_rows(tab,
                   tibble(region=iv_T2sub0,
                          p_T2sub0_bi_FEF_comp=a1[rownames(a1)==iv_T2sub0,4],
                          p_T2sub0_R_FEF_comp=a2[rownames(a2)==iv_T2sub0,4],
                          p_T2sub0_L_FEF_comp=a3[rownames(a3)==iv_T2sub0,4])
  
  )
}
print(tab)
# write_csv(tab,'P:/3024006.02/wd/ggseg_stats_COMPvsMD.csv')
# write_csv(tmp,'P:/3024006.02/wd/ggseg_data_COMPvsMD.csv')

```




